<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ru"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ItemServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ShareIt Server</a> &gt; <a href="index.source.html" class="el_package">ru.practicum.shareit.item.service</a> &gt; <span class="el_source">ItemServiceImpl.java</span></div><h1>ItemServiceImpl.java</h1><pre class="source lang-java linenums">package ru.practicum.shareit.item.service;

import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Sort;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import ru.practicum.shareit.booking.dao.BookingStorage;
import ru.practicum.shareit.booking.model.Booking;
import ru.practicum.shareit.item.dto.CommentDto;
import ru.practicum.shareit.item.mapper.CommentMapper;
import ru.practicum.shareit.request.dao.RequestStorage;
import ru.practicum.shareit.request.model.ItemRequest;
import ru.practicum.shareit.validation.exception.NotFoundObjectException;
import ru.practicum.shareit.validation.exception.ValidationException;
import ru.practicum.shareit.item.dao.CommentStorage;
import ru.practicum.shareit.item.dao.ItemStorage;
import ru.practicum.shareit.item.dto.ItemDto;
import ru.practicum.shareit.item.mapper.ItemMapper;
import ru.practicum.shareit.item.model.Comment;
import ru.practicum.shareit.item.model.Item;
import ru.practicum.shareit.user.dao.UserStorage;
import ru.practicum.shareit.user.model.User;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;
import java.util.Objects;
import java.util.stream.Collectors;


@Service
@RequiredArgsConstructor
@Transactional(readOnly = true)
public class ItemServiceImpl implements ItemService {
    private ItemStorage storage;
    private UserStorage userStorage;
    private CommentStorage commentStorage;
    private BookingStorage bookingStorage;
    private RequestStorage requestStorage;

    @Autowired
<span class="fc" id="L44">    public ItemServiceImpl(ItemStorage storage, UserStorage userStorage, CommentStorage commentStorage, BookingStorage bookingStorage, RequestStorage requestStorage) {</span>
<span class="fc" id="L45">        this.storage = storage;</span>
<span class="fc" id="L46">        this.userStorage = userStorage;</span>
<span class="fc" id="L47">        this.commentStorage = commentStorage;</span>
<span class="fc" id="L48">        this.bookingStorage = bookingStorage;</span>
<span class="fc" id="L49">        this.requestStorage = requestStorage;</span>
<span class="fc" id="L50">    }</span>

    @Override
    @Transactional
    public ItemDto create(Long userId, ItemDto itemDto) {
<span class="fc" id="L55">        Item item = ItemMapper.toItem(itemDto);</span>
<span class="fc" id="L56">        User user = userStorage.findById(userId).get();</span>
<span class="fc" id="L57">        item.setOwner(user);</span>
<span class="fc bfc" id="L58" title="All 2 branches covered.">        if (itemDto.getRequestId() != null) {</span>
<span class="fc" id="L59">            ItemRequest itemRequest = requestStorage.findById(itemDto.getRequestId())</span>
<span class="pc" id="L60">                    .orElseThrow(() -&gt; new NotFoundObjectException(&quot;Запрос с id &quot; + itemDto.getRequestId() + &quot; не найден&quot;));</span>
<span class="fc" id="L61">            item.setItemRequest(itemRequest);</span>
        }
<span class="fc" id="L63">        return ItemMapper.toDto(storage.save(item));</span>
    }

    @Override
    @Transactional
    public CommentDto addComment(Long authorId, Long itemId, CommentDto commentDto) {
<span class="fc bfc" id="L69" title="All 2 branches covered.">        if (commentDto.getText().isEmpty()) {</span>
<span class="fc" id="L70">            throw new ValidationException(&quot;нет текста комментария&quot;);</span>
        }
<span class="fc" id="L72">        User author = userStorage.findById(authorId)</span>
<span class="pc" id="L73">                .orElseThrow(() -&gt; new ValidationException(&quot;нет такого пользователя&quot;));</span>
<span class="fc" id="L74">        Item item = storage.findById(itemId)</span>
<span class="pc" id="L75">                .orElseThrow(() -&gt; new ValidationException(&quot;нет такого пользователя&quot;));</span>

<span class="fc" id="L77">        final PageRequest pageRequest = PageRequest.of(1, 10);</span>
<span class="fc" id="L78">        bookingStorage.findAllByBookerIdAndEndBeforeOrderByIdDesc(authorId, LocalDateTime.now(), null)</span>
<span class="fc" id="L79">                .stream().findFirst()</span>
<span class="fc" id="L80">                .orElseThrow(() -&gt; new ValidationException(&quot;Пользователь с id &quot; +</span>
                        authorId + &quot;не бронировал вещь с id &quot; + itemId));
<span class="fc" id="L82">        Comment comment = CommentMapper.toComment(commentDto);</span>
<span class="fc" id="L83">        comment.setAuthor(author);</span>
<span class="fc" id="L84">        comment.setItem(item);</span>
<span class="fc" id="L85">        comment.setCreated(LocalDateTime.now());</span>
<span class="fc" id="L86">        CommentDto commentDtoNew = CommentMapper.toDto(commentStorage.save(comment));</span>
<span class="fc" id="L87">        return commentDtoNew;</span>
    }


    @Override
    public List&lt;ItemDto&gt; getAll(Long userId, int from, int size) {
<span class="pc bpc" id="L93" title="1 of 4 branches missed.">        if (from &lt; 0 || size &lt;= 0) {</span>
<span class="fc" id="L94">            throw new ValidationException(&quot;не верно указан количество позиций на странице&quot;);</span>
        }
<span class="fc" id="L96">        int page = from / size;</span>
<span class="fc" id="L97">        Sort sortByName = Sort.by(Sort.Direction.DESC, &quot;name&quot;);</span>
<span class="fc" id="L98">        final PageRequest pageRequest = PageRequest.of(page, size, sortByName);</span>
<span class="fc" id="L99">        List&lt;ItemDto&gt; itemDtos = storage.findAll(pageRequest)</span>
<span class="fc" id="L100">                .stream()</span>
<span class="fc" id="L101">                .filter(item -&gt; Objects.equals(item.getOwner().getId(), userId))</span>
<span class="fc" id="L102">                .map(ItemMapper::toDto)</span>
<span class="fc" id="L103">                .collect(Collectors.toList());</span>
<span class="fc" id="L104">        List&lt;ItemDto&gt; itemNewDtos = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L105" title="All 2 branches covered.">        for (ItemDto itemDto : itemDtos) {</span>
<span class="fc" id="L106">            Long id = itemDto.getId();</span>
<span class="fc" id="L107">            Booking lastBookings = bookingStorage.findFirstByItemIdAndEndBeforeOrderByEndDesc(id, LocalDateTime.now());</span>
<span class="fc" id="L108">            Booking nextBookings = bookingStorage.findOneByItemIdAndStartAfterOrderByStartAsc(id, LocalDateTime.now());</span>
<span class="fc" id="L109">            List&lt;Comment&gt; comments = commentStorage.findAllByItemId(id);</span>

<span class="fc" id="L111">            List&lt;CommentDto&gt; commentsDto = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L112" title="All 2 branches covered.">            for (Comment comment : comments) {</span>
<span class="fc" id="L113">                CommentDto commentDto = CommentMapper.toDto(comment);</span>
<span class="fc" id="L114">                commentDto.setAuthorName(comment.getAuthor().getName());</span>
<span class="fc" id="L115">                commentDto.setIdItem(comment.getItem().getId());</span>
<span class="fc" id="L116">                commentsDto.add(commentDto);</span>
<span class="fc" id="L117">            }</span>
<span class="fc" id="L118">            Item item = storage.findById(id).orElseThrow();</span>
<span class="fc" id="L119">            User owner = item.getOwner();</span>
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">            if (Objects.equals(owner.getId(), userId)) {</span>
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">                if (lastBookings != null) {</span>
<span class="fc" id="L122">                    itemDto.setLastBooking(new ItemDto.BookingDtoItem(lastBookings.getId(),</span>
<span class="fc" id="L123">                            lastBookings.getStart(), lastBookings.getEnd(),</span>
<span class="fc" id="L124">                            lastBookings.getBooker().getId()));</span>
                } else {
<span class="nc" id="L126">                    itemDto.setLastBooking(null);</span>
                }
<span class="fc bfc" id="L128" title="All 2 branches covered.">                if (nextBookings != null) {</span>
<span class="fc" id="L129">                    itemDto.setNextBooking(new ItemDto.BookingDtoItem(nextBookings.getId(),</span>
<span class="fc" id="L130">                            nextBookings.getStart(), nextBookings.getEnd(),</span>
<span class="fc" id="L131">                            nextBookings.getBooker().getId()));</span>
                } else {
<span class="fc" id="L133">                    itemDto.setNextBooking(null);</span>
                }
            } else {
<span class="nc" id="L136">                itemDto.setLastBooking(null);</span>
<span class="nc" id="L137">                itemDto.setNextBooking(null);</span>
            }
<span class="pc bpc" id="L139" title="1 of 2 branches missed.">            if (commentsDto == null) {</span>
<span class="nc" id="L140">                itemDto.setComments(null);</span>
            } else {
<span class="fc" id="L142">                itemDto.setComments(commentsDto);</span>
            }
<span class="fc" id="L144">            itemNewDtos.add(itemDto);</span>
<span class="fc" id="L145">        }</span>
<span class="fc" id="L146">        return itemNewDtos;</span>
    }

    @Override
    public ItemDto getById(Long userId, Long id) {
<span class="fc" id="L151">        Item item = storage.findById(id)</span>
<span class="fc" id="L152">                .orElseThrow(() -&gt; new NotFoundObjectException(&quot;Товар с id &quot; + id + &quot; не зарегестрирован&quot;));</span>
<span class="fc" id="L153">        ItemDto itemDto = ItemMapper.toDto(item);</span>
<span class="fc" id="L154">        Booking lastBookings = bookingStorage.findFirstByItemIdAndEndBeforeOrderByEndDesc(id, LocalDateTime.now());</span>
<span class="fc" id="L155">        Booking nextBookings = bookingStorage.findOneByItemIdAndStartAfterOrderByStartAsc(id, LocalDateTime.now());</span>
<span class="fc" id="L156">        List&lt;Comment&gt; comments = commentStorage.findAllByItemId(id);</span>
<span class="fc" id="L157">        Long ownerId = item.getOwner().getId();</span>
<span class="pc bpc" id="L158" title="1 of 2 branches missed.">        if (Objects.equals(ownerId, userId)) {</span>
<span class="pc bpc" id="L159" title="1 of 2 branches missed.">            if (lastBookings != null) {</span>
<span class="fc" id="L160">                itemDto.setLastBooking(new ItemDto.BookingDtoItem(lastBookings.getId(),</span>
<span class="fc" id="L161">                        lastBookings.getStart(), lastBookings.getEnd(),</span>
<span class="fc" id="L162">                        lastBookings.getBooker().getId()));</span>
            }
<span class="fc bfc" id="L164" title="All 2 branches covered.">            if (nextBookings != null) {</span>

<span class="fc" id="L166">                itemDto.setNextBooking(new ItemDto.BookingDtoItem(nextBookings.getId(),</span>
<span class="fc" id="L167">                        nextBookings.getStart(), nextBookings.getEnd(),</span>
<span class="fc" id="L168">                        nextBookings.getBooker().getId()));</span>
            }
        } else {
<span class="nc" id="L171">            itemDto.setLastBooking(null);</span>
<span class="nc" id="L172">            itemDto.setNextBooking(null);</span>
        }
<span class="fc" id="L174">        List&lt;CommentDto&gt; commentsDto = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L175" title="All 2 branches covered.">        for (Comment comment : comments) {</span>
<span class="fc" id="L176">            CommentDto commentDto = CommentMapper.toDto(comment);</span>
<span class="fc" id="L177">            commentDto.setAuthorName(comment.getAuthor().getName());</span>
<span class="fc" id="L178">            commentDto.setIdItem(comment.getItem().getId());</span>
<span class="fc" id="L179">            commentsDto.add(commentDto);</span>
<span class="fc" id="L180">        }</span>
<span class="pc bpc" id="L181" title="1 of 2 branches missed.">        if (commentsDto == null) {</span>
<span class="nc" id="L182">            itemDto.setComments(null);</span>
        } else {
<span class="fc" id="L184">            itemDto.setComments(commentsDto);</span>
        }
<span class="fc" id="L186">        return itemDto;</span>
    }

    @Override
    @Transactional
    public ItemDto update(Long id, ItemDto itemDtoNew, Long userId) {
<span class="fc" id="L192">        Item itemOld = storage.findById(id).get();</span>
<span class="fc" id="L193">        User user = userStorage.findById(userId).get();</span>
<span class="fc" id="L194">        Item itemNew = ItemMapper.toItem(itemDtoNew);</span>
<span class="fc bfc" id="L195" title="All 2 branches covered.">        if (itemNew.getName() == null) {</span>
<span class="fc" id="L196">            itemNew.setName(itemOld.getName());</span>
        }
<span class="fc bfc" id="L198" title="All 2 branches covered.">        if (itemNew.getDescription() == null) {</span>
<span class="fc" id="L199">            itemNew.setDescription(itemOld.getDescription());</span>
        }
<span class="pc bpc" id="L201" title="1 of 2 branches missed.">        if (itemNew.getOwner().getId() == null) {</span>
<span class="fc" id="L202">            itemNew.setOwner(itemOld.getOwner());</span>
        }
<span class="fc bfc" id="L204" title="All 2 branches covered.">        if (itemNew.getAvailable() == null) {</span>
<span class="fc" id="L205">            itemNew.setAvailable(itemOld.getAvailable());</span>
        }
<span class="pc bpc" id="L207" title="1 of 2 branches missed.">        if (itemNew.getItemRequest() == null) {</span>
<span class="fc" id="L208">            itemNew.setItemRequest(itemOld.getItemRequest());</span>
        }
<span class="pc bpc" id="L210" title="1 of 2 branches missed.">        if (!itemNew.getOwner().equals(user)) {</span>
<span class="nc" id="L211">            throw new NotFoundObjectException(&quot;Не верно указан id владельца вещи&quot;);</span>
        }
<span class="fc" id="L213">        itemNew.setId(id);</span>
<span class="fc" id="L214">        return ItemMapper.toDto(storage.save(itemNew));</span>
    }


    @Override
    public List&lt;ItemDto&gt; search(String text, int from, int size) {
<span class="pc bpc" id="L220" title="1 of 4 branches missed.">        if (from &lt; 0 || size &lt;= 0) {</span>
<span class="fc" id="L221">            throw new ValidationException(&quot;не верно указан количество позиций на странице&quot;);</span>
        }
<span class="fc" id="L223">        int page = from / size;</span>
<span class="fc" id="L224">        Sort sortByName = Sort.by(Sort.Direction.ASC, &quot;name&quot;);</span>
<span class="fc" id="L225">        final PageRequest pageRequest = PageRequest.of(page, size, sortByName);</span>

<span class="fc" id="L227">        List&lt;ItemDto&gt; fitItemDto = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L228" title="All 2 branches covered.">        if (text.isBlank()) {</span>
<span class="fc" id="L229">            return fitItemDto;</span>
        }
<span class="fc" id="L231">        return storage.findByDescriptionContainingIgnoreCase(text, pageRequest)</span>
<span class="fc" id="L232">                .stream().filter(Item::getAvailable)</span>
<span class="fc" id="L233">                .map(ItemMapper::toDto)</span>
<span class="fc" id="L234">                .collect(Collectors.toList());</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>